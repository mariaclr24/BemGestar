<!doctype html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BemGestar - Avaliar Presen√ßas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="CSS/style.css" />
    <link rel="stylesheet" href="CSS/dashboard_cliente.css" />
  </head>
  <body>
    <script src="JS/validar_login.js"></script>

    <header>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
          <a class="navbar-brand" href="dashboard_prof.html">
            <img src="Imagem/logo.jpg" alt="BemGestar Logo" width="40" height="40" class="d-inline-block align-text-top" />
            BemGestar
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item"><a class="nav-link active" href="dashboard_prof.html">In√≠cio</a></li>
              <li class="nav-item"><a class="nav-link" href="login.html">Logout</a></li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="container my-5">
      <h2 class="text-center mb-4">Presen√ßas da Aula</h2>
      <div id="info-aula" class="mb-4 text-center"></div>
      <div id="presencas" class="table-responsive"></div>
    </main>

    <footer class="text-center py-4">
      &copy; 2025 BemGestar. Todos os direitos reservados.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="JS/logout.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const id_aula = params.get('id_aula');
      const token = localStorage.getItem('token');

      if (!id_aula) {
        document.querySelector('main').innerHTML = '<div class="alert alert-danger">ID da aula em falta.</div>';
        throw new Error('ID da aula em falta');
      }

      async function carregarPresencas() {
        const res = await fetch(`/api/presencas/${id_aula}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const data = await res.json();
        if (data.erro) return alert(data.erro);

        document.getElementById('info-aula').innerHTML =
          `<strong>Data:</strong> ${new Date(data.aula.data).toLocaleString()} | <strong>Terapia:</strong> ${data.aula.nome_terapia} | <strong>Espa√ßo:</strong> ${data.aula.nome_espaco}`;

        const tabela = `
          <table class="table table-bordered">
            <thead><tr><th>Nome</th><th>Email</th><th>Question√°rio</th><th>Biosinal</th><th>An√°lise</th><th>Avalia√ß√£o</th></tr></thead>
            <tbody>
              ${data.participantes.map(p => `
                <tr>
                  <td>${p.nome}</td>
                  <td>${p.email}</td>
                  <td>
                    ${p.questionario ? `<button class="btn btn-sm btn-outline-secondary" onclick="verQuestionario(${id_aula}, ${p.id_utilizador})">Ver</button>` : '‚ùå'}
                  </td>
                  <td>${p.biosinal ? '‚úÖ' : '‚ùå'}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" id="btn-analisar-${p.id_utilizador}" onclick="toggleAnalise(${id_aula}, ${p.id_utilizador})">Ver An√°lise</button>
                  </td>
                  <td>
                    <input type="file" id="file-${p.id_utilizador}" class="form-control form-control-sm mb-1">
                    <button class="btn btn-sm btn-success" onclick="submeterAvaliacao(${p.id_utilizador})">Submeter</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>`;

        document.getElementById('presencas').innerHTML = tabela;
      }

      async function toggleAnalise(id_aula, id_utilizador) {
        const linhaExistente = document.querySelector(`#analise-${id_utilizador}`);
        const botao = document.getElementById(`btn-analisar-${id_utilizador}`);

        if (linhaExistente) {
          linhaExistente.remove();
          botao.textContent = "Ver An√°lise";
          botao.classList.remove('btn-danger');
          botao.classList.add('btn-outline-primary');
          return;
        }

        const res = await fetch(`/api/biosinal/analise/${id_aula}?id_utilizador=${id_utilizador}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const data = await res.json();
        if (data.erro) return alert(data.erro);

        const tr = document.createElement('tr');
        tr.id = `analise-${id_utilizador}`;
        tr.innerHTML = `
          <td colspan="6">
            <div class="border rounded p-3 bg-light">
              <h5 class="mb-3">An√°lise EMG de ${id_utilizador}</h5>
              <img src="${data.grafico}" alt="Gr√°fico EMG" class="img-fluid mb-3"/>
              <ul>
                <li><strong>RMS:</strong> ${parseFloat(data.rms).toFixed(3)}</li>
                <li><strong>M√©dia:</strong> ${parseFloat(data.media).toFixed(3)}</li>
                <li><strong>Desvio Padr√£o:</strong> ${parseFloat(data.desvio).toFixed(3)}</li>
              </ul>
              <a href="${data.tabela}" class="btn btn-outline-secondary btn-sm" download>üì• Descarregar Tabela de Picos (CSV)</a>
            </div>
          </td>
        `;

        const linhaOriginal = document.querySelector(`#file-${id_utilizador}`).closest('tr');
        linhaOriginal.parentNode.insertBefore(tr, linhaOriginal.nextSibling);
        botao.textContent = "Fechar An√°lise";
        botao.classList.remove('btn-outline-primary');
        botao.classList.add('btn-danger');
      }

      async function verQuestionario(id_aula, id_utilizador) {
        const existente = document.getElementById(`quest-${id_utilizador}`);
        if (existente) return existente.remove();

        const res = await fetch(`/api/questionario/${id_aula}/${id_utilizador}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const data = await res.json();
        if (data.erro) return alert(data.erro);

        const r = data.resposta;
        const tr = document.createElement('tr');
        tr.id = `quest-${id_utilizador}`;
        tr.innerHTML = `
           <td colspan="6">
            <div class="border rounded p-3 bg-white">
              <h5>Respostas do Question√°rio</h5>
              <ul>
                <li><strong>Classifica√ß√£o Geral (1‚Äì5):</strong> ${r.classificacao_geral}</li>
                <li><strong>A aula foi clara?</strong> ${r.aula_foi_clara ? 'Sim' : 'N√£o'}</li>
                <li><strong>O profissional acompanhou durante a aula?</strong> ${r.acompanhou_profissional ? 'Sim' : 'N√£o'}</li>
                <li><strong>Colocou d√∫vidas?</strong> ${r.colocou_duvidas}</li>
                <li><strong>A aula ajudou no bem-estar?</strong> ${r.ajudou_bem_estar}</li>
                <li><strong>Contribui√ß√£o positiva (1‚Äì5):</strong> ${r.contribuicao_positiva}</li>
                <li><strong>N√≠vel de esfor√ßo f√≠sico (1‚Äì10):</strong> ${r.nivel_esforco}</li>
                <li><strong>Sentiu dor muscular?</strong> ${r.dor_muscular ? 'Sim' : 'N√£o'}</li>
                <li><strong>Sentiu desconforto durante a aula?</strong> ${r.sentiu_desconforto ? 'Sim' : 'N√£o'}</li>
                <li><strong>Fadiga ap√≥s aula (1‚Äì10):</strong> ${r.fadiga}</li>
                <li><strong>Conseguiu acompanhar os exerc√≠cios? (1‚Äì5):</strong> ${r.coordenacao}</li>
                <li><strong>Teve dificuldades de equil√≠brio?</strong> ${r.equilibrio ? 'Sim' : 'N√£o'}</li>
                <li><strong>Coment√°rios adicionais:</strong> ${r.comentarios || '-'}</li>
              </ul>
            </div>
          </td>`;
        const linhaOriginal = document.querySelector(`#file-${id_utilizador}`).closest('tr');
        linhaOriginal.parentNode.insertBefore(tr, linhaOriginal.nextSibling);
      }

      async function submeterAvaliacao(id_utilizador) {
        const fileInput = document.getElementById(`file-${id_utilizador}`);
        const file = fileInput.files[0];
        if (!file) return alert('Escolha um ficheiro para enviar.');

        const formData = new FormData();
        formData.append('ficheiro', file);
        formData.append('id_utilizador', id_utilizador);
        formData.append('id_aula', id_aula);

        const res = await fetch('/api/avaliacao-sessao/upload', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });

        const data = await res.json();
        alert(data.mensagem || data.erro);
      }

      carregarPresencas();
    </script>
  </body>
</html>
